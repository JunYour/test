<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excelæ•°æ®å¤„ç†å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            /* Increased max-width for 3 columns */
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .title {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .upload-section {
            background: #f8f9ff;
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            background: #f0f2ff;
            border-color: #5a6fd8;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .process-section {
            display: grid;
            /* Changed to be responsive for 3 items */
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .process-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e6ff;
            display: flex;
            /* Added for flex layout */
            flex-direction: column;
            /* Added for flex layout */
        }

        .process-card>*:last-child {
            margin-top: auto;
            /* Pushes the result area to the bottom */
        }

        .process-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            font-size: 1.5rem;
        }

        .process-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 15px;
        }

        .process-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .process-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result-area {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e0e6ff;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .data-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
        }

        .data-table tr:nth-child(even) {
            background-color: #f8f9ff;
        }

        .download-btn {
            background: linear-gradient(45deg, #FF6B6B, #ee5a52);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 15px;
        }

        .download-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .sample-data {
            background: #f0f8ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .sample-data h4 {
            color: #333;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .process-section {
                grid-template-columns: 1fr;
            }

            .title {
                font-size: 2rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="title">ğŸ“Š Excelæ•°æ®å¤„ç†å·¥å…·</h1>

        <div class="upload-section">
            <h3>ğŸ“ ä¸Šä¼ Excelæ–‡ä»¶</h3>
            <p style="color: #666; margin: 10px 0;">æ”¯æŒ.xlsxå’Œ.xlsæ ¼å¼</p>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                é€‰æ‹©æ–‡ä»¶
            </button>
            <div id="fileName" style="margin-top: 10px; color: #666;"></div>

            <div id="sheetSelector" style="margin-top: 20px; display: none;">
                <h4 style="color: #333; margin-bottom: 10px;">ğŸ“‹ é€‰æ‹©è¦å¤„ç†çš„å·¥ä½œè¡¨ï¼š</h4>
                <select id="sheetSelect"
                    style="padding: 10px; border: 2px solid #667eea; border-radius: 8px; font-size: 1rem; width: 100%; max-width: 300px;">
                </select>
                <button class="upload-btn" onclick="loadSelectedSheet()" style="margin-top: 10px; padding: 10px 20px;">
                    åŠ è½½é€‰ä¸­çš„å·¥ä½œè¡¨
                </button>
            </div>

            <div id="dataPreview" style="margin-top: 20px; display: none;">
                <h4 style="color: #333;">ğŸ“Š æ•°æ®é¢„è§ˆï¼ˆå‰5è¡Œï¼‰ï¼š</h4>
                <div id="previewTable" style="margin-top: 10px; overflow-x: auto;"></div>
            </div>
        </div>

        <div class="process-section">
            <div class="process-card">
                <h3><span class="icon">ğŸ”„</span>æ•°æ®å»é‡å¤„ç†</h3>
                <p style="color: #666; margin-bottom: 15px;">åŸºäºé€‰æ‹©çš„åˆ—ç§»é™¤é‡å¤çš„è¡Œæ•°æ®</p>

                <div id="dedupeColumnSelector" style="margin-bottom: 15px; display: none;">
                    <div style="background: #f8f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: #333; margin-bottom: 10px;">ğŸ¯ é€‰æ‹©å»é‡ä¾æ®åˆ—ï¼š</h4>

                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: 600; color: #555; margin-bottom: 5px;">
                                ğŸ” å»é‡æ¨¡å¼ï¼š
                            </label>
                            <select id="dedupeMode"
                                style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;"
                                onchange="toggleDedupeColumns()">
                                <option value="all">å®Œæ•´è¡Œå»é‡ï¼ˆæ‰€æœ‰åˆ—éƒ½ç›¸åŒæ‰ç®—é‡å¤ï¼‰</option>
                                <option value="selected">æŒ‡å®šåˆ—å»é‡ï¼ˆé€‰æ‹©çš„åˆ—ç›¸åŒå°±ç®—é‡å¤ï¼‰</option>
                            </select>
                        </div>

                        <div id="dedupeColumnsSelection" style="margin-bottom: 10px; display: none;">
                            <label style="display: block; font-weight: 600; color: #555; margin-bottom: 5px;">
                                ğŸ“‹ é€‰æ‹©å»é‡ä¾æ®åˆ—ï¼ˆå¤šé€‰ï¼‰ï¼š
                            </label>
                            <div id="dedupeColumnsCheckboxes"
                                style="max-height: 120px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: white;">
                            </div>
                        </div>

                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: 600; color: #555; margin-bottom: 5px;">
                                âš™ï¸ ä¿ç•™ç­–ç•¥ï¼š
                            </label>
                            <select id="keepStrategy"
                                style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                                <option value="first">ä¿ç•™ç¬¬ä¸€æ¬¡å‡ºç°çš„æ•°æ®</option>
                                <option value="last">ä¿ç•™æœ€åä¸€æ¬¡å‡ºç°çš„æ•°æ®</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button class="process-btn" id="dedupeBtn" onclick="deduplicateData()" disabled>
                    æ‰§è¡Œå»é‡
                </button>
                <div class="sample-data">
                    <h4>ç¤ºä¾‹æ•°æ®æ ¼å¼ï¼š</h4>
                    <pre style="color: #555; font-size: 0.9rem;">æå››  æ•°å­¦: 60
æå››  è¯­æ–‡: 60
æå››  æ•°å­¦: 60  â† é‡å¤è¡Œ</pre>
                    <p style="color: #888; font-size: 0.8rem; margin-top: 5px;">*å¯é€‰æ‹©åŸºäºæ‰€æœ‰åˆ—æˆ–æŒ‡å®šåˆ—è¿›è¡Œå»é‡</p>
                </div>
                <div class="result-area" style="max-height: 600px;
    overflow: auto;" id="dedupeResult"></div>
            </div>

            <div class="process-card">
                <h3><span class="icon">ğŸ“‹</span>æ•°æ®åˆå¹¶å¤„ç†</h3>
                <p style="color: #666; margin-bottom: 15px;">å°†åŒå­¦ç”Ÿçš„ç§‘ç›®æˆç»©åˆå¹¶åˆ°ä¸€è¡Œ</p>

                <div id="columnSelector" style="margin-bottom: 15px; display: none;">
                    <div style="background: #f8f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: #333; margin-bottom: 10px;">ğŸ¯ é€‰æ‹©åˆå¹¶åˆ—ï¼š</h4>

                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: 600; color: #555; margin-bottom: 5px;">
                                ğŸ“ åˆ†ç»„ä¾æ®åˆ—ï¼ˆç›¸åŒå€¼ä¼šè¢«åˆå¹¶ï¼‰ï¼š
                            </label>
                            <select id="groupByColumn"
                                style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                            </select>
                        </div>

                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: 600; color: #555; margin-bottom: 5px;">
                                ğŸ”— è¦åˆå¹¶çš„åˆ—ï¼ˆå¤šé€‰ï¼‰ï¼š
                            </label>
                            <div id="mergeColumnsCheckboxes"
                                style="max-height: 120px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: white;">
                            </div>
                        </div>

                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: 600; color: #555; margin-bottom: 5px;">
                                âš™ï¸ åˆå¹¶åˆ†éš”ç¬¦ï¼š
                            </label>
                            <select id="separator"
                                style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                                <option value=", ">é€—å· (,)</option>
                                <option value=" | ">ç«–çº¿ (|)</option>
                                <option value="; ">åˆ†å· (;)</option>
                                <option value=" / ">æ–œçº¿ (/)</option>
                                <option value=" - ">æ¨ªçº¿ (-)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button class="process-btn" id="mergeBtn" onclick="mergeData()" disabled>
                    æ‰§è¡Œåˆå¹¶
                </button>
                <div class="sample-data">
                    <h4>åˆå¹¶åæ ¼å¼ï¼š</h4>
                    <pre style="color: #555; font-size: 0.9rem;">æå››  æ•°å­¦: 60, è¯­æ–‡: 60, è‹±æ–‡: 60</pre>
                    <p style="color: #888; font-size: 0.8rem; margin-top: 5px;">*å¯è‡ªå®šä¹‰åˆ†ç»„åˆ—å’Œåˆå¹¶åˆ—</p>
                </div>
                <div class="result-area" style="max-height: 600px;overflow: auto;" id="mergeResult"></div>
            </div>

            <div class="process-card">
                <h3><span class="icon">âœ¨</span>æ¡ä»¶èµ‹å€¼å¤„ç†</h3>
                <p style="color: #666; margin-bottom: 15px;">æ ¹æ®æŒ‡å®šåˆ—çš„æ¡ä»¶ï¼Œå°†ä¸€åˆ—çš„å€¼èµ‹ç»™å¦ä¸€åˆ—ã€‚</p>

                <div id="conditionalAssignSelector" style="margin-bottom: 15px; display: none;">
                    <div style="background: #f8f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: #333; margin-bottom: 10px;">ğŸ¯ è®¾ç½®èµ‹å€¼è§„åˆ™ï¼š</h4>

                        <label style="display: block; font-weight: 600; color: #555; margin-bottom: 5px;">
                            IF (å¦‚æœ):
                        </label>
                        <div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                            <select id="conditionColumn"
                                style="width:100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; margin-bottom:10px;"></select>
                            <select id="conditionOperator" onchange="toggleConditionValueInput()"
                                style="width:100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; margin-bottom:10px;">
                                <option value="==">ç­‰äº (==)</option>
                                <option value="!=">ä¸ç­‰äº (!=)</option>
                                <option value="contains">åŒ…å« (contains)</option>
                                <option value="not-contains">ä¸åŒ…å« (not contains)</option>
                                <option value="is-empty">ä¸ºç©º (is empty)</option>
                                <option value="is-not-empty">ä¸ä¸ºç©º (is not empty)</option>
                                <option value=">">å¤§äº (>)</option>
                                <option value="<">å°äº (<)< /option>
                                <option value=">=">å¤§äºç­‰äº (>=)</option>
                                <option value="<=">å°äºç­‰äº (<=)< /option>
                            </select>
                            <input type="text" id="conditionValue" placeholder="è¾“å…¥æ¡ä»¶å€¼"
                                style="width:100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
                        </div>

                        <label style="display: block; font-weight: 600; color: #555; margin-bottom: 5px;">
                            THEN (é‚£ä¹ˆ):
                        </label>
                        <div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                            <label style="font-size: 0.9rem; color: #555;">å°†æ­¤åˆ—:</label>
                            <select id="destinationColumn"
                                style="width:100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; margin-bottom:10px;"></select>
                            <label style="font-size: 0.9rem; color: #555;">çš„å€¼è®¾ä¸ºè¿™ä¸€åˆ—çš„å€¼:</label>
                            <select id="sourceColumn"
                                style="width:100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;"></select>
                        </div>
                    </div>
                </div>

                <button class="process-btn" id="conditionalAssignBtn" onclick="performConditionalAssignment()" disabled>
                    æ‰§è¡Œèµ‹å€¼
                </button>
                <div class="sample-data">
                    <h4>ç¤ºä¾‹é€»è¾‘ï¼š</h4>
                    <pre style="color: #555; font-size: 0.9rem;">å¦‚æœ [è®¢å•çŠ¶æ€åˆ—] ç­‰äº "å·²æ”¯ä»˜",
é‚£ä¹ˆå°† [å‘è´§çŠ¶æ€åˆ—] è®¾ä¸º [é»˜è®¤çŠ¶æ€åˆ—] çš„å€¼</pre>
                    <p style="color: #888; font-size: 0.8rem; margin-top: 5px;">*æºåˆ—å’Œç›®æ ‡åˆ—å¯ä»¥æ˜¯åŒä¸€åˆ—</p>
                </div>
                <div class="result-area" style="max-height: 600px;overflow: auto;" id="conditionalAssignResult"></div>
            </div>
        </div>

        <div
            style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); border: 1px solid #e0e6ff; margin-bottom: 20px;">
            <h3 style="color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <span class="icon" style="font-size: 1.5rem;">ğŸ—‚ï¸</span>
                æ•°æ®ç®¡ç†ä¸­å¿ƒ
            </h3>

            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <button class="process-btn" onclick="showOriginalData()" id="showOriginalBtn" disabled
                    style="background: linear-gradient(45deg, #3498db, #2980b9);">
                    ğŸ“‹ æŸ¥çœ‹åŸå§‹æ•°æ®
                </button>
                <button class="process-btn" onclick="exportMultipleSheets()" id="exportMultipleBtn" disabled
                    style="background: linear-gradient(45deg, #e74c3c, #c0392b);">
                    ğŸ“¦ å¯¼å‡ºæ‰€æœ‰ç»“æœåˆ°ä¸€ä¸ªExcel
                </button>
                <button class="process-btn" onclick="clearAllData()"
                    style="background: linear-gradient(45deg, #95a5a6, #7f8c8d);">
                    ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®
                </button>
            </div>

            <div class="result-area" style="max-height: 600px;
    overflow: auto;" id="originalDataResult"></div>
        </div>
    </div>

    <script>
        let workbook = null;
        let originalData = [];
        let deduplicatedData = [];
        let mergedData = [];
        let conditionalAssignResult = []; // NEW: for conditional assignment result

        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = `å·²é€‰æ‹©: ${file.name}`;
                readExcelFile(file);
            }
        });

        function readExcelFile(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array' });

                    // æ˜¾ç¤ºå·¥ä½œè¡¨é€‰æ‹©å™¨
                    displaySheetSelector(workbook.SheetNames);

                } catch (error) {
                    alert('æ–‡ä»¶è¯»å–é”™è¯¯: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function displaySheetSelector(sheetNames) {
            const sheetSelector = document.getElementById('sheetSelector');
            const sheetSelect = document.getElementById('sheetSelect');

            // æ¸…ç©ºé€‰é¡¹
            sheetSelect.innerHTML = '';

            // æ·»åŠ å·¥ä½œè¡¨é€‰é¡¹
            sheetNames.forEach((sheetName, index) => {
                const option = document.createElement('option');
                option.value = sheetName;
                option.textContent = `${sheetName} (å·¥ä½œè¡¨${index + 1})`;
                sheetSelect.appendChild(option);
            });

            sheetSelector.style.display = 'block';

            // é»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
            if (sheetNames.length > 0) {
                loadSheet(sheetNames[0]);
            }
        }

        function loadSelectedSheet() {
            const selectedSheet = document.getElementById('sheetSelect').value;
            loadSheet(selectedSheet);
        }

        function loadSheet(sheetName) {
            try {
                const worksheet = workbook.Sheets[sheetName];

                // è½¬æ¢ä¸ºJSONæ•°ç»„
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                    header: 1,
                    defval: ""
                });

                originalData = jsonData.filter(row => row.some(cell => cell !== ""));

                // æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
                displayDataPreview(originalData, sheetName);

                // å¯ç”¨å¤„ç†æŒ‰é’®å’Œæ•°æ®ç®¡ç†æŒ‰é’®
                document.getElementById('dedupeBtn').disabled = false;
                document.getElementById('mergeBtn').disabled = false;
                document.getElementById('conditionalAssignBtn').disabled = false; // NEW
                document.getElementById('showOriginalBtn').disabled = false;
                document.getElementById('exportMultipleBtn').disabled = false;

                // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
                document.getElementById('dedupeResult').innerHTML = '';
                document.getElementById('mergeResult').innerHTML = '';
                document.getElementById('conditionalAssignResult').innerHTML = ''; // NEW
                deduplicatedData = [];
                mergedData = [];
                conditionalAssignResult = []; // NEW

                console.log(`${sheetName} æ•°æ®:`, originalData);

            } catch (error) {
                alert('å·¥ä½œè¡¨è¯»å–é”™è¯¯: ' + error.message);
            }
        }

        function displayDataPreview(data, sheetName) {
            const previewDiv = document.getElementById('dataPreview');
            const previewTable = document.getElementById('previewTable');

            if (data.length === 0) {
                previewDiv.style.display = 'none';
                return;
            }

            // åªæ˜¾ç¤ºå‰5è¡Œæ•°æ®
            const previewData = data.slice(0, 5);

            let html = `<p style="color: #666; margin-bottom: 10px;">å·¥ä½œè¡¨: <strong>${sheetName}</strong> | æ€»è¡Œæ•°: <strong>${data.length}</strong></p>`;
            html += '<table class="data-table" style="font-size: 0.9rem;">';

            // è¡¨å¤´
            if (previewData.length > 0) {
                const maxCols = Math.max(...previewData.map(row => row.length));
                html += '<tr>';
                for (let i = 0; i < maxCols; i++) {
                    html += `<th>åˆ—${String.fromCharCode(65 + i)}</th>`;
                }
                html += '</tr>';
            }

            // æ•°æ®è¡Œ
            previewData.forEach((row, index) => {
                html += '<tr>';
                row.forEach(cell => {
                    html += `<td>${cell || ''}</td>`;
                });
                html += '</tr>';
            });

            html += '</table>';

            if (data.length > 5) {
                html += '<p style="color: #888; font-size: 0.9rem; margin-top: 10px;">... è¿˜æœ‰æ›´å¤šæ•°æ®</p>';
            }

            previewTable.innerHTML = html;
            previewDiv.style.display = 'block';

            // ç”Ÿæˆåˆ—é€‰æ‹©å™¨
            generateColumnSelectors(data);
        }

        function generateColumnSelectors(data) {
            if (data.length === 0) return;

            // Selectors for Merge
            const columnSelector = document.getElementById('columnSelector');
            const groupByColumn = document.getElementById('groupByColumn');
            const mergeColumnsCheckboxes = document.getElementById('mergeColumnsCheckboxes');

            // Selectors for Dedupe
            const dedupeColumnSelector = document.getElementById('dedupeColumnSelector');
            const dedupeColumnsCheckboxes = document.getElementById('dedupeColumnsCheckboxes');

            // NEW: Selectors for Conditional Assign
            const conditionalAssignSelector = document.getElementById('conditionalAssignSelector');
            const conditionColumn = document.getElementById('conditionColumn');
            const sourceColumn = document.getElementById('sourceColumn');
            const destinationColumn = document.getElementById('destinationColumn');

            // Clear existing options
            groupByColumn.innerHTML = '';
            mergeColumnsCheckboxes.innerHTML = '';
            dedupeColumnsCheckboxes.innerHTML = '';
            conditionColumn.innerHTML = ''; // NEW
            sourceColumn.innerHTML = ''; // NEW
            destinationColumn.innerHTML = ''; // NEW

            // è·å–åˆ—æ•°
            const maxColumns = Math.max(...data.map(row => row.length));

            for (let i = 0; i < maxColumns; i++) {
                const columnLetter = String.fromCharCode(65 + i);
                const optionText = `åˆ—${columnLetter} (ç¬¬${i + 1}åˆ—)`;

                // Option for dropdowns
                const option = document.createElement('option');
                option.value = i;
                option.textContent = optionText;

                // Option for dropdowns (cloned)
                groupByColumn.appendChild(option.cloneNode(true));
                conditionColumn.appendChild(option.cloneNode(true));
                sourceColumn.appendChild(option.cloneNode(true));
                destinationColumn.appendChild(option.cloneNode(true));

                // Checkboxes for Merge
                const mergeCheckboxDiv = document.createElement('div');
                mergeCheckboxDiv.innerHTML = `<input type="checkbox" id="mergeCol${i}" value="${i}" style="margin-right: 8px;"><label for="mergeCol${i}" style="cursor: pointer;">${optionText}</label>`;
                mergeColumnsCheckboxes.appendChild(mergeCheckboxDiv);

                // Checkboxes for Dedupe
                const dedupeCheckboxDiv = document.createElement('div');
                dedupeCheckboxDiv.innerHTML = `<input type="checkbox" id="dedupeCol${i}" value="${i}" style="margin-right: 8px;"><label for="dedupeCol${i}" style="cursor: pointer;">${optionText}</label>`;
                dedupeColumnsCheckboxes.appendChild(dedupeCheckboxDiv);
            }

            // é»˜è®¤é€‰æ‹©ï¼šç¬¬ä¸€åˆ—ä½œä¸ºåˆ†ç»„ï¼Œå…¶ä»–åˆ—ä½œä¸ºåˆå¹¶ï¼ˆåˆå¹¶åŠŸèƒ½ï¼‰
            if (maxColumns > 1) {
                groupByColumn.value = '0';
                for (let i = 1; i < maxColumns; i++) {
                    document.getElementById(`mergeCol${i}`).checked = true;
                }
            }

            // é»˜è®¤é€‰æ‹©ï¼šæ‰€æœ‰åˆ—éƒ½é€‰ä¸­ï¼ˆå»é‡åŠŸèƒ½ï¼‰
            for (let i = 0; i < maxColumns; i++) {
                document.getElementById(`dedupeCol${i}`).checked = true;
            }

            columnSelector.style.display = 'block';
            dedupeColumnSelector.style.display = 'block';
            conditionalAssignSelector.style.display = 'block'; // NEW
        }

        function toggleDedupeColumns() {
            const dedupeMode = document.getElementById('dedupeMode').value;
            const dedupeColumnsSelection = document.getElementById('dedupeColumnsSelection');

            dedupeColumnsSelection.style.display = (dedupeMode === 'selected') ? 'block' : 'none';
        }

        // NEW: Hide condition value input if operator is is-empty or is-not-empty
        function toggleConditionValueInput() {
            const operator = document.getElementById('conditionOperator').value;
            const valueInput = document.getElementById('conditionValue');
            valueInput.style.display = (operator === 'is-empty' || operator === 'is-not-empty') ? 'none' : 'block';
        }

        function deduplicateData() {
            if (originalData.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ æ–‡ä»¶å¹¶é€‰æ‹©å·¥ä½œè¡¨');
                return;
            }

            const dedupeMode = document.getElementById('dedupeMode').value;
            const keepStrategy = document.getElementById('keepStrategy').value;

            let dedupeColumnIndices = [];

            if (dedupeMode === 'selected') {
                const maxColumns = Math.max(...originalData.map(row => row.length));
                for (let i = 0; i < maxColumns; i++) {
                    const checkbox = document.getElementById(`dedupeCol${i}`);
                    if (checkbox && checkbox.checked) {
                        dedupeColumnIndices.push(i);
                    }
                }

                if (dedupeColumnIndices.length === 0) {
                    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€åˆ—ä½œä¸ºå»é‡ä¾æ®');
                    return;
                }
            }

            const seen = new Map();
            const duplicateIndexes = new Set();

            originalData.forEach((row, index) => {
                let keyStr;

                if (dedupeMode === 'all') {
                    keyStr = JSON.stringify(row);
                } else {
                    const keyValues = dedupeColumnIndices.map(colIndex =>
                        row[colIndex] !== undefined ? row[colIndex] : ''
                    );
                    keyStr = JSON.stringify(keyValues);
                }

                if (seen.has(keyStr)) {
                    const firstIndex = seen.get(keyStr);
                    if (keepStrategy === 'first') {
                        duplicateIndexes.add(index);
                    } else {
                        duplicateIndexes.add(firstIndex);
                        seen.set(keyStr, index);
                    }
                } else {
                    seen.set(keyStr, index);
                }
            });

            deduplicatedData = originalData.filter((row, index) => !duplicateIndexes.has(index));

            const removedCount = originalData.length - deduplicatedData.length;
            let reportTitle = `å»é‡åæ•°æ® (åŸå§‹${originalData.length}è¡Œï¼Œå»é™¤${removedCount}è¡Œé‡å¤æ•°æ®)`;

            if (dedupeMode === 'selected') {
                const selectedColumns = dedupeColumnIndices.map(i =>
                    `åˆ—${String.fromCharCode(65 + i)}`
                ).join(', ');
                reportTitle += ` | åŸºäºåˆ—: ${selectedColumns}`;
            } else {
                reportTitle += ' | åŸºäº: å®Œæ•´è¡Œ';
            }

            reportTitle += ` | ç­–ç•¥: ${keepStrategy === 'first' ? 'ä¿ç•™é¦–æ¬¡å‡ºç°' : 'ä¿ç•™æœ€åå‡ºç°'}`;

            displayResult('dedupeResult', deduplicatedData, reportTitle);
            console.log('å»é‡åæ•°æ®:', deduplicatedData);
        }

        function mergeData() {
            if (originalData.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ æ–‡ä»¶å¹¶é€‰æ‹©å·¥ä½œè¡¨');
                return;
            }

            const groupByColumnIndex = parseInt(document.getElementById('groupByColumn').value);
            const separator = document.getElementById('separator').value;

            const mergeColumnIndices = [];
            const maxColumns = Math.max(...originalData.map(row => row.length));
            for (let i = 0; i < maxColumns; i++) {
                const checkbox = document.getElementById(`mergeCol${i}`);
                if (checkbox && checkbox.checked) {
                    mergeColumnIndices.push(i);
                }
            }

            if (mergeColumnIndices.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€åˆ—è¿›è¡Œåˆå¹¶');
                return;
            }

            const grouped = {};

            originalData.forEach(row => {
                if (row.length > groupByColumnIndex) {
                    const groupKey = row[groupByColumnIndex] || '';

                    if (!grouped[groupKey]) {
                        grouped[groupKey] = {};
                        mergeColumnIndices.forEach(colIndex => {
                            grouped[groupKey][colIndex] = [];
                        });
                    }

                    mergeColumnIndices.forEach(colIndex => {
                        if (row.length > colIndex && row[colIndex] != null) {
                            const value = String(row[colIndex]).trim();
                            if (value && !grouped[groupKey][colIndex].includes(value)) {
                                grouped[groupKey][colIndex].push(value);
                            }
                        }
                    });
                }
            });

            const headers = [`åˆ†ç»„åˆ— (åˆ—${String.fromCharCode(65 + groupByColumnIndex)})`];
            mergeColumnIndices.forEach(colIndex => {
                headers.push(`åˆå¹¶åˆ— (åˆ—${String.fromCharCode(65 + colIndex)})`);
            });

            mergedData = Object.keys(grouped).map(groupKey => {
                const resultRow = [groupKey];
                mergeColumnIndices.forEach(colIndex => {
                    resultRow.push(grouped[groupKey][colIndex].join(separator));
                });
                return resultRow;
            });

            displayResultWithHeaders('mergeResult', mergedData, 'åˆå¹¶åæ•°æ®', headers);
            console.log('åˆå¹¶åæ•°æ®:', mergedData);
        }

        // NEW: Conditional Assignment Logic
        function performConditionalAssignment() {
            if (originalData.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ æ–‡ä»¶å¹¶é€‰æ‹©å·¥ä½œè¡¨');
                return;
            }

            const conditionColIndex = parseInt(document.getElementById('conditionColumn').value);
            const operator = document.getElementById('conditionOperator').value;
            const conditionValue = document.getElementById('conditionValue').value;
            const sourceColIndex = parseInt(document.getElementById('sourceColumn').value);
            const destColIndex = parseInt(document.getElementById('destinationColumn').value);

            // Create a deep copy to avoid modifying originalData
            const processedData = JSON.parse(JSON.stringify(originalData));
            let rowsAffected = 0;

            processedData.forEach(row => {
                const valueToCheck = row[conditionColIndex];

                if (evaluateCondition(valueToCheck, operator, conditionValue)) {
                    const sourceValue = row[sourceColIndex] !== undefined ? row[sourceColIndex] : '';

                    // Pad the row with empty strings if destination index is out of bounds
                    while (row.length <= destColIndex) {
                        row.push('');
                    }

                    row[destColIndex] = sourceValue;
                    rowsAffected++;
                }
            });

            conditionalAssignResult = processedData;
            const reportTitle = `æ¡ä»¶èµ‹å€¼åæ•°æ® (${rowsAffected} è¡Œè¢«ä¿®æ”¹)`;
            displayResult('conditionalAssignResult', conditionalAssignResult, reportTitle);
            console.log('Conditional assignment result:', conditionalAssignResult);
        }

        // NEW: Helper function to evaluate conditions
        function evaluateCondition(val1, operator, val2) {
            const v1 = (val1 === undefined || val1 === null) ? '' : String(val1).trim();
            const v2 = (val2 === undefined || val2 === null) ? '' : String(val2).trim();

            if (operator === 'is-empty') return v1 === '';
            if (operator === 'is-not-empty') return v1 !== '';

            const num1 = parseFloat(v1);
            const num2 = parseFloat(v2);
            // A valid numeric comparison happens if both values are numbers and are not empty strings
            const isNumeric = !isNaN(num1) && !isNaN(num2) && v1 !== '' && v2 !== '';

            switch (operator) {
                case '==': return v1 === v2;
                case '!=': return v1 !== v2;
                case '>': return isNumeric ? num1 > num2 : v1 > v2;
                case '<': return isNumeric ? num1 < num2 : v1 < v2;
                case '>=': return isNumeric ? num1 >= num2 : v1 >= v2;
                case '<=': return isNumeric ? num1 <= num2 : v1 <= v2;
                case 'contains': return v1.includes(v2);
                case 'not-contains': return !v1.includes(v2);
                default: return false;
            }
        }


        function displayResult(containerId, data, title) {
            displayResultWithHeaders(containerId, data, title, null);
        }

        // REVISED: To handle rows with varying lengths correctly
        function displayResultWithHeaders(containerId, data, title, headers) {
            const container = document.getElementById(containerId);

            if (!data || data.length === 0) {
                container.innerHTML = `<p style="color:#888;">${title ? title + ': ' : ''}æ²¡æœ‰æ•°æ®å¯æ˜¾ç¤º</p>`;
                return;
            }

            let html = `<h4>${title} (å…±${data.length}è¡Œ)</h4>`;
            html += '<table class="data-table">';

            const maxCols = Math.max(...data.map(row => (row ? row.length : 0)));

            // Table Header
            html += '<thead><tr>';
            if (headers && headers.length > 0) {
                headers.forEach(header => {
                    html += `<th>${header}</th>`;
                });
                for (let i = headers.length; i < maxCols; i++) {
                    html += `<th>åˆ—${String.fromCharCode(65 + i)}</th>`;
                }
            } else {
                for (let i = 0; i < maxCols; i++) {
                    html += `<th>åˆ—${String.fromCharCode(65 + i)}</th>`;
                }
            }
            html += '</tr></thead>';

            // Table Body
            html += '<tbody>';
            data.forEach(row => {
                html += '<tr>';
                for (let i = 0; i < maxCols; i++) {
                    const cell = row ? row[i] : undefined;
                    html += `<td>${(cell !== undefined && cell !== null) ? cell : ''}</td>`;
                }
                html += '</tr>';
            });
            html += '</tbody>';

            html += '</table>';
            html += `<button class="download-btn" onclick="downloadData('${containerId}')">ä¸‹è½½Excelæ–‡ä»¶</button>`;
            container.innerHTML = html;
        }

        function downloadData(type) {
            let dataToDownload = [];
            let filename = '';

            if (type === 'dedupeResult') {
                dataToDownload = deduplicatedData;
                filename = 'å»é‡åæ•°æ®.xlsx';
            } else if (type === 'mergeResult') {
                dataToDownload = mergedData;
                filename = 'åˆå¹¶åæ•°æ®.xlsx';
            } else if (type === 'conditionalAssignResult') { // NEW
                dataToDownload = conditionalAssignResult;
                filename = 'æ¡ä»¶èµ‹å€¼åæ•°æ®.xlsx';
            } else if (type === 'originalDataResult') {
                dataToDownload = originalData;
                filename = 'åŸå§‹æ•°æ®.xlsx';
            }

            if (dataToDownload.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯ä¸‹è½½');
                return;
            }

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dataToDownload);

            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

            XLSX.writeFile(wb, filename);
        }

        function showOriginalData() {
            if (originalData.length === 0) {
                alert('æ²¡æœ‰åŸå§‹æ•°æ®å¯æ˜¾ç¤º');
                return;
            }

            const currentSheet = document.getElementById('sheetSelect').value || 'åŸå§‹æ•°æ®';
            displayResult('originalDataResult', originalData, `åŸå§‹æ•°æ® (${currentSheet})`);
        }

        function exportMultipleSheets() {
            if (originalData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }

            const wb = XLSX.utils.book_new();
            let alertMsg = '';

            if (originalData.length > 0) {
                const wsOriginal = XLSX.utils.aoa_to_sheet(originalData);
                XLSX.utils.book_append_sheet(wb, wsOriginal, "åŸå§‹æ•°æ®");
                alertMsg += `- åŸå§‹æ•°æ® (${originalData.length}è¡Œ)\n`;
            }

            if (deduplicatedData.length > 0) {
                const wsDedupe = XLSX.utils.aoa_to_sheet(deduplicatedData);
                XLSX.utils.book_append_sheet(wb, wsDedupe, "å»é‡åæ•°æ®");
                alertMsg += `- å»é‡åæ•°æ® (${deduplicatedData.length}è¡Œ)\n`;
            }

            if (mergedData.length > 0) {
                const wsMerged = XLSX.utils.aoa_to_sheet(mergedData);
                XLSX.utils.book_append_sheet(wb, wsMerged, "åˆå¹¶åæ•°æ®");
                alertMsg += `- åˆå¹¶åæ•°æ® (${mergedData.length}è¡Œ)\n`;
            }

            if (conditionalAssignResult.length > 0) { // NEW
                const wsAssigned = XLSX.utils.aoa_to_sheet(conditionalAssignResult);
                XLSX.utils.book_append_sheet(wb, wsAssigned, "æ¡ä»¶èµ‹å€¼åæ•°æ®");
                alertMsg += `- æ¡ä»¶èµ‹å€¼åæ•°æ® (${conditionalAssignResult.length}è¡Œ)`;
            }

            const timestamp = new Date().toLocaleString('zh-CN').replace(/[/:]/g, '-').replace(/\s/g, '_');
            const filename = `æ•°æ®å¤„ç†ç»“æœ_${timestamp}.xlsx`;

            XLSX.writeFile(wb, filename);

            alert(`å·²å¯¼å‡ºExcelæ–‡ä»¶ï¼š${filename}\nåŒ…å«çš„å·¥ä½œè¡¨ï¼š\n${alertMsg}`);
        }

        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                workbook = null;
                originalData = [];
                deduplicatedData = [];
                mergedData = [];
                conditionalAssignResult = []; // NEW

                document.getElementById('fileName').textContent = '';
                document.getElementById('sheetSelector').style.display = 'none';
                document.getElementById('dataPreview').style.display = 'none';
                document.getElementById('columnSelector').style.display = 'none';
                document.getElementById('dedupeColumnSelector').style.display = 'none';
                document.getElementById('conditionalAssignSelector').style.display = 'none'; // NEW

                document.getElementById('dedupeResult').innerHTML = '';
                document.getElementById('mergeResult').innerHTML = '';
                document.getElementById('originalDataResult').innerHTML = '';
                document.getElementById('conditionalAssignResult').innerHTML = ''; // NEW

                document.getElementById('dedupeBtn').disabled = true;
                document.getElementById('mergeBtn').disabled = true;
                document.getElementById('showOriginalBtn').disabled = true;
                document.getElementById('exportMultipleBtn').disabled = true;
                document.getElementById('conditionalAssignBtn').disabled = true; // NEW

                document.getElementById('fileInput').value = '';
            }
        }
    </script>
</body>

</html>

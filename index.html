<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Face-API.js äººè„¸æ¯”å¯¹ç¤ºä¾‹</title>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
      font-size: 28px;
    }

    .content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 20px;
    }

    .section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
    }

    .section h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #555;
    }

    .video-container {
      position: relative;
      width: 100%;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      background: #000;
    }

    #video {
      width: 100%;
      height: auto;
      display: block;
    }

    #canvas {
      position: absolute;
      top: 0;
      left: 0;
    }

    .reference-container {
      position: relative;
      width: 100%;
      min-height: 200px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      background: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #referenceImg {
      max-width: 100%;
      max-height: 400px;
      display: none;
    }

    #referenceCanvas {
      position: absolute;
      top: 0;
      left: 114px;
    }

    .upload-area {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .hidden {
      display: none;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .secondary {
      background: #6c757d;
    }

    input[type="file"] {
      display: none;
    }

    .status {
      text-align: center;
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
    }

    .loading {
      background: #fff3cd;
      color: #856404;
    }

    .ready {
      background: #d4edda;
      color: #155724;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
    }

    .match-result {
      margin-top: 15px;
      padding: 15px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      text-align: center;
      display: none;
    }

    .match {
      background: #d4edda;
      color: #155724;
      display: block;
    }

    .no-match {
      background: #f8d7da;
      color: #721c24;
      display: block;
    }

    .checking {
      background: #d1ecf1;
      color: #0c5460;
      display: block;
    }

    @media (max-width: 768px) {
      .content {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ­ äººè„¸è¯†åˆ«ä¸æ¯”å¯¹</h1>

    <div id="status" class="status loading">æ­£åœ¨åŠ è½½æ¨¡å‹...</div>

    <div class="content">
      <div class="section">
        <h2>ğŸ“· å®æ—¶æ‘„åƒå¤´</h2>
        <div class="video-container">
          <video id="video" autoplay muted></video>
          <canvas id="canvas"></canvas>
        </div>
        <div class="controls">
          <button id="startBtn" disabled>å¼€å¯æ‘„åƒå¤´</button>
          <button id="stopBtn" disabled>å…³é—­æ‘„åƒå¤´</button>
        </div>
      </div>

      <div class="section">
        <h2>ğŸ–¼ï¸ å‚è€ƒç…§ç‰‡</h2>
        <div class="reference-container" id="referenceContainer">
          <div class="upload-area" id="uploadArea">
            <p>ğŸ“ ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸Šä¼ å‚è€ƒäººè„¸ç…§ç‰‡</p>
          </div>
          <img id="referenceImg" alt="å‚è€ƒç…§ç‰‡">
          <canvas id="referenceCanvas"></canvas>
        </div>
        <div class="controls">
          <button onclick="document.getElementById('fileInput').click()">ä¸Šä¼ ç…§ç‰‡</button>
          <button class="secondary" id="clearBtn" disabled>æ¸…é™¤ç…§ç‰‡</button>
        </div>
        <input type="file" id="fileInput" accept="image/*">
        <div id="matchResult" class="match-result"></div>
      </div>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const referenceImg = document.getElementById('referenceImg');
    const referenceCanvas = document.getElementById('referenceCanvas');
    const statusDiv = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const clearBtn = document.getElementById('clearBtn');
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');
    const matchResult = document.getElementById('matchResult');

    let stream = null;
    let isDetecting = false;
    let referenceFaceDescriptor = null;

    // åŠ è½½æ¨¡å‹
    async function loadModels() {
      const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model/';

      try {
        statusDiv.textContent = 'æ­£åœ¨åŠ è½½äººè„¸æ£€æµ‹æ¨¡å‹...';
        await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);

        statusDiv.textContent = 'æ­£åœ¨åŠ è½½ç‰¹å¾ç‚¹æ¨¡å‹...';
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);

        statusDiv.textContent = 'æ­£åœ¨åŠ è½½äººè„¸è¯†åˆ«æ¨¡å‹...';
        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);

        statusDiv.className = 'status ready';
        statusDiv.textContent = 'âœ“ æ¨¡å‹åŠ è½½å®Œæˆï¼è¯·ä¸Šä¼ å‚è€ƒç…§ç‰‡å¹¶å¼€å¯æ‘„åƒå¤´';
        startBtn.disabled = false;
      } catch (error) {
        statusDiv.className = 'status error';
        statusDiv.textContent = 'âœ— æ¨¡å‹åŠ è½½å¤±è´¥: ' + error.message;
        console.error('Error loading models:', error);
      }
    }

    // å¤„ç†ä¸Šä¼ çš„ç…§ç‰‡
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];


      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (event) => {
        referenceImg.src = event.target.result;
        referenceImg.style.display = 'block';
        uploadArea.classList.add('hidden');
        clearBtn.disabled = false;

        await processReferenceImage();
      };
      reader.readAsDataURL(file);
    });

    // å¤„ç†å‚è€ƒç…§ç‰‡
    async function processReferenceImage() {


      try {
        matchResult.className = 'match-result checking';
        matchResult.textContent = 'æ­£åœ¨åˆ†æå‚è€ƒç…§ç‰‡...';
        await referenceImg.decode();

        const detection = await faceapi
          .detectSingleFace(referenceImg)
          .withFaceLandmarks()
          .withFaceDescriptor();


        if (detection) {
          console.log(detection)
          referenceFaceDescriptor = detection.descriptor;

          // ç»˜åˆ¶æ£€æµ‹ç»“æœ
          const displaySize = { width: referenceImg.width, height: referenceImg.height };
          referenceCanvas.width = displaySize.width;
          referenceCanvas.height = displaySize.height;

          const resizedDetection = faceapi.resizeResults(detection, displaySize);
          faceapi.draw.drawDetections(referenceCanvas, resizedDetection);
          faceapi.draw.drawFaceLandmarks(referenceCanvas, resizedDetection);

          matchResult.style.display = 'block';
          matchResult.className = 'match-result ready';
          matchResult.textContent = 'âœ“ å‚è€ƒäººè„¸å·²è¯†åˆ«ï¼Œå¯ä»¥å¼€å§‹æ¯”å¯¹';

          console.log('å‚è€ƒäººè„¸ç‰¹å¾å·²æå–');
        } else {

          const ctx = referenceCanvas.getContext('2d');
          ctx.clearRect(0, 0, referenceCanvas.width, referenceCanvas.height);

          matchResult.style.display = 'block';
          matchResult.className = 'match-result error';
          matchResult.textContent = 'âœ— æœªåœ¨ç…§ç‰‡ä¸­æ£€æµ‹åˆ°äººè„¸ï¼Œè¯·é‡æ–°ä¸Šä¼ ';
          referenceFaceDescriptor = null;
        }
      } catch (error) {

        const ctx = referenceCanvas.getContext('2d');
        ctx.clearRect(0, 0, referenceCanvas.width, referenceCanvas.height);

        matchResult.style.display = 'block';
        console.error('å¤„ç†å‚è€ƒç…§ç‰‡é”™è¯¯:', error);
        matchResult.className = 'match-result error';
        matchResult.textContent = 'âœ— å¤„ç†ç…§ç‰‡å¤±è´¥: ' + error.message;
      }
    }

    // æ¸…é™¤å‚è€ƒç…§ç‰‡
    clearBtn.addEventListener('click', () => {
      referenceImg.src = '';
      referenceImg.style.display = 'none';
      uploadArea.classList.remove('hidden');
      clearBtn.disabled = true;
      referenceFaceDescriptor = null;
      matchResult.style.display = 'none';

      const ctx = referenceCanvas.getContext('2d');
      ctx.clearRect(0, 0, referenceCanvas.width, referenceCanvas.height);

      fileInput.value = '';
    });

    // å¼€å¯æ‘„åƒå¤´
    async function startVideo() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { width: 640, height: 480 }
        });
        video.srcObject = stream;

        await new Promise((resolve) => {
          video.onloadedmetadata = () => {
            video.play();
            resolve();
          };
        });

        await new Promise((resolve) => {
          video.oncanplay = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            console.log('Video ready:', video.videoWidth, 'x', video.videoHeight);
            resolve();
          };
        });

        startBtn.disabled = true;
        stopBtn.disabled = false;

        isDetecting = true;
        detectFaces();
      } catch (error) {
        statusDiv.className = 'status error';
        statusDiv.textContent = 'âœ— æ— æ³•è®¿é—®æ‘„åƒå¤´: ' + error.message;
        console.error('Error accessing webcam:', error);
      }
    }

    // åœæ­¢æ‘„åƒå¤´
    function stopVideo() {
      isDetecting = false;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }

      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      startBtn.disabled = false;
      stopBtn.disabled = true;

      if (referenceFaceDescriptor) {
        matchResult.className = 'match-result';
        matchResult.textContent = 'æ‘„åƒå¤´å·²å…³é—­';
      }
    }

    // äººè„¸æ£€æµ‹ä¸æ¯”å¯¹
    async function detectFaces() {
      if (!isDetecting) return;

      if (video.readyState !== video.HAVE_ENOUGH_DATA) {
        requestAnimationFrame(detectFaces);
        return;
      }

      try {
        const detections = await faceapi
          .detectAllFaces(video)
          .withFaceLandmarks()
          .withFaceDescriptors();

        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (detections.length > 0) {
          const resizedDetections = faceapi.resizeResults(detections, {
            width: canvas.width - 120,
            height: canvas.height - 90
          });

          faceapi.draw.drawDetections(canvas, resizedDetections);
          faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);

          console.log("referenceFaceDescriptor", referenceFaceDescriptor)
          // å¦‚æœæœ‰å‚è€ƒäººè„¸ï¼Œè¿›è¡Œæ¯”å¯¹
          if (referenceFaceDescriptor) {
            let bestMatch = null;
            let bestDistance = 1;

            resizedDetections.forEach(detection => {
              const distance = faceapi.euclideanDistance(
                referenceFaceDescriptor,
                detection.descriptor
              );

              if (distance < bestDistance) {
                bestDistance = distance;
                bestMatch = detection;
              }

              // åœ¨äººè„¸æ¡†ä¸Šæ˜¾ç¤ºç›¸ä¼¼åº¦
              const similarity = ((1 - distance) * 100).toFixed(1);
              const box = detection.detection.box;
              const drawBox = new faceapi.draw.DrawBox(box, {
                label: `ç›¸ä¼¼åº¦: ${similarity}%`
              });
              drawBox.draw(canvas);
            });

            // é˜ˆå€¼ï¼š0.6 ä»¥ä¸‹è®¤ä¸ºæ˜¯åŒä¸€ä¸ªäºº
            if (bestDistance < 0.6) {
              const similarity = ((1 - bestDistance) * 100).toFixed(1);
              matchResult.className = 'match-result match';
              matchResult.textContent = `âœ“ åŒ¹é…æˆåŠŸï¼ç›¸ä¼¼åº¦: ${similarity}%`;
            } else {
              matchResult.className = 'match-result no-match';
              matchResult.textContent = `âœ— æœªåŒ¹é… (ç›¸ä¼¼åº¦è¿‡ä½)`;
            }
          } else {
            matchResult.className = 'match-result checking';
            matchResult.textContent = `æ£€æµ‹åˆ° ${detections.length} å¼ äººè„¸ï¼Œè¯·å…ˆä¸Šä¼ å‚è€ƒç…§ç‰‡`;
          }
        } else {
          if (referenceFaceDescriptor) {
            matchResult.className = 'match-result checking';
            matchResult.textContent = 'æœªæ£€æµ‹åˆ°äººè„¸';
          }
        }
      } catch (error) {
        console.error('Detection error:', error);
      }

      requestAnimationFrame(detectFaces);
    }

    // äº‹ä»¶ç›‘å¬
    startBtn.addEventListener('click', startVideo);
    stopBtn.addEventListener('click', stopVideo);

    // ç­‰å¾…åŠ è½½
    function waitForFaceAPI() {
      if (typeof faceapi !== 'undefined') {
        console.log('face-api.js loaded successfully');
        loadModels();
      } else {
        console.log('Waiting for face-api.js...');
        setTimeout(waitForFaceAPI, 200);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', waitForFaceAPI);
    } else {
      waitForFaceAPI();
    }
  </script>
</body>

</html>

<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>人脸识别</title>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }

    .status-bar {
      background: white;
      padding: 8px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }

    .signal-icons {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .battery {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .header {
      background: white;
      padding: 16px;
      display: flex;
      align-items: center;
      box-shadow: 0 1px 0 rgba(0, 0, 0, 0.05);
    }

    .back-btn {
      font-size: 28px;
      color: #999;
      cursor: pointer;
      line-height: 1;
      margin-right: 16px;
      font-weight: 300;
    }

    .header-title {
      font-size: 18px;
      font-weight: 400;
      color: #333;
    }

    .container {
      padding: 0;
      background: white;
    }

    .video-section {
      background: white;
      padding: 24px 16px;
    }

    .video-container {
      position: relative;
      width: 100%;
      aspect-ratio: 9/10;
      border-radius: 0;
      overflow: hidden;
      background: #f8f8f8;
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .scan-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60%;
      aspect-ratio: 1;
      z-index: 2;
    }

    .corner-line {
      position: absolute;
      background: #5BC4A5;
    }

    .corner-line.tl-v {
      top: 0;
      left: 0;
      width: 3px;
      height: 60px;
    }

    .corner-line.tl-h {
      top: 0;
      left: 0;
      width: 60px;
      height: 3px;
    }

    .corner-line.tr-v {
      top: 0;
      right: 0;
      width: 3px;
      height: 60px;
    }

    .corner-line.tr-h {
      top: 0;
      right: 0;
      width: 60px;
      height: 3px;
    }

    .corner-line.bl-v {
      bottom: 0;
      left: 0;
      width: 3px;
      height: 60px;
    }

    .corner-line.bl-h {
      bottom: 0;
      left: 0;
      width: 60px;
      height: 3px;
    }

    .corner-line.br-v {
      bottom: 0;
      right: 0;
      width: 3px;
      height: 60px;
    }

    .corner-line.br-h {
      bottom: 0;
      right: 0;
      width: 60px;
      height: 3px;
    }

    .center-line {
      position: absolute;
      left: 0;
      right: 0;
      top: 50%;
      height: 2px;
      background: #5BC4A5;
      transform: translateY(-50%);
    }

    .face-placeholder {
      position: relative;
      z-index: 1;
    }

    .face-head {
      width: 120px;
      height: 100px;
      background: #F5DEB3;
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      position: relative;
      margin: 0 auto;
    }

    .hair {
      width: 100px;
      height: 50px;
      background: #5F6876;
      position: absolute;
      top: -5px;
      left: 10px;
      border-radius: 50% 50% 0 0 / 100% 100% 0 0;
    }

    .hair::after {
      content: '';
      width: 60px;
      height: 40px;
      background: #5F6876;
      position: absolute;
      top: 10px;
      right: -15px;
      border-radius: 0 80% 80% 0;
      transform: rotate(-20deg);
    }

    .eye {
      width: 8px;
      height: 8px;
      background: #333;
      border-radius: 50%;
      position: absolute;
      top: 48px;
    }

    .eye.left {
      left: 35px;
    }

    .eye.right {
      right: 35px;
    }

    .nose {
      width: 20px;
      height: 3px;
      background: #F5DEB3;
      border: 2px solid #E5CEB3;
      border-bottom: none;
      border-radius: 50% 50% 0 0;
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
    }

    .mouth {
      width: 24px;
      height: 12px;
      border: 2px solid #333;
      border-top: none;
      border-radius: 0 0 50% 50%;
      position: absolute;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
    }

    .neck {
      width: 50px;
      height: 20px;
      background: #F5DEB3;
      position: absolute;
      bottom: -20px;
      left: 50%;
      transform: translateX(-50%);
    }

    .body {
      width: 80px;
      height: 60px;
      background: #B8BEC5;
      position: relative;
      margin: 20px auto 0;
      clip-path: polygon(30% 0, 70% 0, 100% 100%, 0 100%);
    }

    .collar {
      width: 40px;
      height: 30px;
      background: white;
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      clip-path: polygon(20% 0, 80% 0, 100% 100%, 0 100%);
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
      position: absolute;
      top: 0;
      left: 0;
    }

    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
    }

    .video-overlay {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 16px;
      font-weight: 500;
      z-index: 10;
      display: none;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .video-overlay.match {
      background: rgba(46, 125, 50, 0.95);
      color: white;
      display: block;
    }

    .video-overlay.no-match {
      background: rgba(198, 40, 40, 0.95);
      color: white;
      display: block;
    }

    .video-overlay.checking {
      background: rgba(21, 101, 192, 0.95);
      color: white;
      display: block;
    }

    .divider {
      height: 1px;
      background: #e5e5e5;
      margin: 0 16px 24px;
    }

    .instructions {
      padding: 0 16px 32px;
      background: white;
    }

    .instruction-item {
      display: flex;
      align-items: flex-start;
      margin-bottom: 12px;
      font-size: 15px;
      color: #666;
      line-height: 1.6;
    }

    .instruction-item:last-child {
      margin-bottom: 0;
    }

    .tips-section {
      display: flex;
      justify-content: space-around;
      padding: 0 16px 32px;
      background: white;
    }

    .tip-item {
      text-align: center;
      flex: 1;
      position: relative;
    }

    .tip-icon-wrapper {
      width: 72px;
      height: 72px;
      margin: 0 auto 10px;
      position: relative;
    }

    .tip-icon {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tip-icon svg {
      width: 48px;
      height: 48px;
    }

    .tip-check {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 24px;
      height: 24px;
      background: #5BC4A5;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
      font-weight: bold;
    }

    .tip-label {
      font-size: 14px;
      color: #333;
    }

    .button-section {
      padding: 0 16px 32px;
      background: white;
    }

    .start-button {
      width: 100%;
      background: #5BC4A5;
      color: white;
      border: none;
      padding: 16px;
      border-radius: 24px;
      font-size: 17px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .start-button:active {
      opacity: 0.8;
      transform: scale(0.98);
    }

    .start-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* active 状态用于显示 "停止检测" 按钮 (红色) */
    .start-button.active {
      background: #f44336;
    }

    .match-result {
      margin-top: 16px;
      padding: 14px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      text-align: center;
      display: none;
    }

    /* 状态消息栏的样式 */
    .status-message {
      text-align: center;
      padding: 12px 16px;
      font-size: 14px;
      background: #FFF3E0;
      color: #E65100;
    }

    .status-message.ready {
      background: #E8F5E9;
      color: #2E7D32;
    }

    .status-message.error {
      background: #FFEBEE;
      color: #C62828;
    }
  </style>
</head>

<body>
  <div id="statusMessage" class="status-message">正在加载模型...</div>

  <div class="container">
    <div class="video-section">
      <div class="video-container">
        <div class="scan-frame">
          <div class="corner-line tl-v"></div>
          <div class="corner-line tl-h"></div>
          <div class="corner-line tr-v"></div>
          <div class="corner-line tr-h"></div>
          <div class="corner-line bl-v"></div>
          <div class="corner-line bl-h"></div>
          <div class="corner-line br-v"></div>
          <div class="corner-line br-h"></div>
          <div class="center-line"></div>
        </div>

        <div id="facePlaceholder" class="face-placeholder" style=" padding: 20px; border-radius: 10px;">
          <svg viewBox="0 0 280 320" style="width: 200px; height: auto; display: block; margin: 0 auto;">
            <defs>
              <linearGradient id="shieldGradModern" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#1E88E5;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#0D47A1;stop-opacity:1" />
              </linearGradient>

              <rect id="scannerLine" x="80" y="100" width="120" height="2" fill="url(#scannerGrad)">
                <animate attributeName="y" values="100; 220; 100" dur="2s" repeatCount="indefinite" />
              </rect>

              <linearGradient id="scannerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#42A5F5;stop-opacity:0" />
                <stop offset="50%" style="stop-color:#81D4FA;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#42A5F5;stop-opacity:0" />
              </linearGradient>

              <filter id="glow">
                <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur" />
                <feMerge>
                  <feMergeNode in="blur" />
                  <feMergeNode in="SourceGraphic" />
                </feMerge>
              </filter>
            </defs>

            <path d="M140 20 L250 70 L250 160 Q250 240 140 300 Q30 240 30 160 L30 70 Z" fill="url(#shieldGradModern)"
              stroke="#00B0FF" stroke-width="4" filter="url(#glow)" />

            <rect x="90" y="100" width="100" height="120" rx="12" fill="none" stroke="#81D4FA" stroke-width="1.5"
              opacity="0.5" filter="url(#glow)" />

            <line x1="90" y1="115" x2="90" y2="100" stroke="#81D4FA" stroke-width="4" stroke-linecap="round"
              filter="url(#glow)" />
            <line x1="90" y1="100" x2="105" y2="100" stroke="#81D4FA" stroke-width="4" stroke-linecap="round"
              filter="url(#glow)" />

            <line x1="190" y1="100" x2="175" y2="100" stroke="#81D4FA" stroke-width="4" stroke-linecap="round"
              filter="url(#glow)" />
            <line x1="190" y1="100" x2="190" y2="115" stroke="#81D4FA" stroke-width="4" stroke-linecap="round"
              filter="url(#glow)" />

            <line x1="90" y1="205" x2="90" y2="220" stroke="#81D4FA" stroke-width="4" stroke-linecap="round"
              filter="url(#glow)" />
            <line x1="90" y1="220" x2="105" y2="220" stroke="#81D4FA" stroke-width="4" stroke-linecap="round"
              filter="url(#glow)" />

            <line x1="175" y1="220" x2="190" y2="220" stroke="#81D4FA" stroke-width="4" stroke-linecap="round"
              filter="url(#glow)" />
            <line x1="190" y1="220" x2="190" y2="205" stroke="#81D4FA" stroke-width="4" stroke-linecap="round"
              filter="url(#glow)" />

            <use href="#scannerLine" />

            <circle cx="140" cy="155" r="30" fill="#F5CBA7" stroke="#37474F" stroke-width="1" />

            <path d="M108 150 Q110 120 140 125 Q170 120 172 150 L168 150 Q168 135 140 132 Q112 135 112 150 Z"
              fill="#263238" />

            <ellipse cx="108" cy="158" rx="4" ry="9" fill="#E2B895" />
            <ellipse cx="172" cy="158" rx="4" ry="9" fill="#E2B895" />

            <ellipse cx="128" cy="152" rx="3.5" ry="4.5" fill="#263238" />
            <ellipse cx="152" cy="152" rx="3.5" ry="4.5" fill="#263238" />

            <path d="M122 145 Q128 143 133 144" stroke="#263238" stroke-width="2" fill="none" stroke-linecap="round" />
            <path d="M147 144 Q152 143 158 145" stroke="#263238" stroke-width="2" fill="none" stroke-linecap="round" />

            <path d="M132 175 Q140 180 148 175" stroke="#263238" stroke-width="2" fill="none" stroke-linecap="round" />

            <rect x="128" y="185" width="24" height="14" rx="3" fill="#F5CBA7" />

            <path d="M110 199 L128 199 L128 210 Q128 220 140 225 Q152 220 152 210 L152 199 L170 199 L175 240 L105 240 Z"
              fill="#1565C0" />

            <path d="M140 199 L133 210 L140 225 L147 210 Z" fill="#0D47A1" />

            <path d="M128 199 L135 210 L140 203 L145 210 L152 199" fill="white" opacity="1" />
          </svg>
        </div>
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="videoOverlay" class="video-overlay"></div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="instructions">
      <div class="instruction-item">
        1.请确认由本人亲自操作；
      </div>
      <div class="instruction-item">
        2.请将脸置于提示框内，并按提示完成动作。
      </div>
    </div>

    <div class="tips-section">
      <div class="tip-item">
        <div class="tip-icon-wrapper">
          <div class="tip-icon">
            <svg viewBox="0 0 48 48" fill="none">
              <rect x="8" y="4" width="32" height="40" rx="3" fill="#E0E0E0" />
              <rect x="10" y="6" width="28" height="36" rx="2" fill="white" />
              <circle cx="24" cy="10" r="1.5" fill="#999" />
              <path d="M20 28 L24 32 L28 28" stroke="#5BC4A5" stroke-width="2" stroke-linecap="round" fill="none" />
              <circle cx="20" cy="22" r="2" fill="#666" />
              <circle cx="28" cy="22" r="2" fill="#666" />
            </svg>
          </div>
          <div class="tip-check">✓</div>
        </div>
        <div class="tip-label">正对手机</div>
      </div>

      <div class="tip-item">
        <div class="tip-icon-wrapper">
          <div class="tip-icon">
            <svg viewBox="0 0 48 48" fill="none">
              <rect x="10" y="8" width="28" height="32" rx="2" fill="#FFF9C4" />
              <circle cx="24" cy="24" r="8" fill="#FFEB3B" />
              <path
                d="M24 10 L24 6 M24 42 L24 38 M38 24 L42 24 M6 24 L10 24 M34.5 13.5 L37.5 10.5 M10.5 37.5 L13.5 34.5 M34.5 34.5 L37.5 37.5 M10.5 10.5 L13.5 13.5"
                stroke="#FDD835" stroke-width="2" stroke-linecap="round" />
            </svg>
          </div>
          <div class="tip-check">✓</div>
        </div>
        <div class="tip-label">光线充足</div>
      </div>

      <div class="tip-item">
        <div class="tip-icon-wrapper">
          <div class="tip-icon">
            <svg viewBox="0 0 48 48" fill="none">
              <circle cx="24" cy="20" r="12" fill="#FFE0B2" />
              <circle cx="20" cy="18" r="2" fill="#333" />
              <circle cx="28" cy="18" r="2" fill="#333" />
              <path d="M20 24 Q24 26 28 24" stroke="#333" stroke-width="1.5" fill="none" />
              <path d="M24 32 L24 36" stroke="#999" stroke-width="2" stroke-linecap="round" />
              <path d="M20 36 L28 36" stroke="#999" stroke-width="2" stroke-linecap="round" />
              <path d="M22 36 L22 40 M26 36 L26 40" stroke="#999" stroke-width="1.5" stroke-linecap="round" />
            </svg>
          </div>
          <div class="tip-check">✓</div>
        </div>
        <div class="tip-label">放慢动作</div>
      </div>
    </div>

    <div class="button-section">
      <button id="startBtn" class="start-button" disabled>开始检测</button>
      <div id="matchResult" class="match-result"></div>
    </div>
  </div>

  <img id="referenceImg" style="display: none;" crossorigin="anonymous">

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const referenceImg = document.getElementById('referenceImg');
    const statusMessage = document.getElementById('statusMessage');
    const startBtn = document.getElementById('startBtn');
    const videoOverlay = document.getElementById('videoOverlay');
    const facePlaceholder = document.getElementById('facePlaceholder');

    let stream = null;
    let isDetecting = false;
    let referenceFaceDescriptor = null;

    // Face-API 模型的公共 CDN 路径
    const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model/';
    // !!! 请替换为您自己的参考照片 URL !!!
    const REFERENCE_IMAGE_URL = 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=400&fit=crop';
    // 匹配阈值 (越小越严格, 0.6 是常见默认值)
    const MATCH_THRESHOLD = 0.6;

    /**
     * 1. 加载 Face-API 模型和参考人脸特征
     */
    async function loadModelsAndReference() {
      try {
        statusMessage.textContent = '正在加载人脸检测模型...';
        // 依次加载必要的模型
        await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);

        statusMessage.textContent = '正在提取参考人脸特征...';
        await loadReferenceImage();

        statusMessage.className = 'status-message ready';
        statusMessage.textContent = '✓ 准备就绪，点击按钮开始检测';
        startBtn.disabled = false;
      } catch (error) {
        statusMessage.className = 'status-message error';
        statusMessage.textContent = `✗ 初始化失败: ${error.message}`;
        console.error('模型加载或参考人脸提取失败:', error);
      }
    }

    /**
     * 2. 提取参考图片的人脸描述符
     */
    async function loadReferenceImage() {
      return new Promise((resolve, reject) => {
        referenceImg.src = REFERENCE_IMAGE_URL;

        referenceImg.onload = async () => {
          try {
            await referenceImg.decode();

            const detection = await faceapi
              .detectSingleFace(referenceImg)
              .withFaceLandmarks()
              .withFaceDescriptor();

            if (detection) {
              referenceFaceDescriptor = detection.descriptor;
              console.log('参考人脸特征已提取完成');
              resolve();
            } else {
              reject(new Error('参考图片中未检测到清晰人脸'));
            }
          } catch (error) {
            reject(new Error('提取参考特征时发生错误: ' + error.message));
          }
        };

        referenceImg.onerror = () => {
          reject(new Error('参考图片加载失败 (URL可能无效或跨域问题)'));
        };
      });
    }

    /**
     * 3. 启动摄像头并开始检测
     */
    async function startVideo() {
      if (!referenceFaceDescriptor) {
        statusMessage.className = 'status-message error';
        statusMessage.textContent = '✗ 错误: 参考人脸数据未准备好。';
        return;
      }

      try {
        // 获取摄像头视频流，使用前置摄像头
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: 'user'
          }
        });
        video.srcObject = stream;

        // 等待视频元数据加载和播放
        await new Promise(resolve => video.onloadedmetadata = () => {
          video.play();
          resolve();
        });

        // 必须在视频加载完成后设置 Canvas 的实际分辨率，以保证绘图准确
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // 切换 UI 状态
        video.style.display = 'block';
        canvas.style.display = 'block';
        facePlaceholder.style.display = 'none';

        startBtn.textContent = '停止检测';
        startBtn.classList.add('active');

        isDetecting = true;
        detectFaces(); // 启动人脸检测循环
      } catch (error) {
        statusMessage.className = 'status-message error';
        statusMessage.textContent = '✗ 无法访问摄像头，请检查权限。';
        console.error('启动摄像头失败:', error);
      }
    }

    /**
     * 4. 停止视频流和检测循环
     */
    function stopVideo() {
      isDetecting = false;
      if (stream) {
        // 停止所有轨道 (摄像头)
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }

      // 切换 UI 状态
      video.style.display = 'none';
      canvas.style.display = 'none';
      videoOverlay.style.display = 'none';
      facePlaceholder.style.display = 'block';

      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      startBtn.textContent = '开始检测';
      startBtn.classList.remove('active');
    }

    /**
     * 5. 持续人脸检测和比对的核心循环
     */
    async function detectFaces() {
      if (!isDetecting) return;

      // 仅在视频帧数据可用时进行检测
      if (video.readyState < video.HAVE_ENOUGH_DATA) {
        requestAnimationFrame(detectFaces);
        return;
      }

      try {
        // 进行人脸检测、特征点和描述符提取
        const detections = await faceapi
          .detectAllFaces(video)
          .withFaceLandmarks()
          .withFaceDescriptors();

        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (detections.length > 0) {
          // 将检测结果尺寸重新调整到 Canvas 的显示尺寸
          const resizedDetections = faceapi.resizeResults(detections, {
            width: canvas.width,
            height: canvas.height
          });

          // 在 Canvas 上绘制人脸特征点
          faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);

          let bestDistance = Infinity; // 初始距离设为最大

          resizedDetections.forEach(detection => {
            // 计算实时人脸和参考人脸之间的欧氏距离
            const distance = faceapi.euclideanDistance(
              referenceFaceDescriptor,
              detection.descriptor
            );

            if (distance < bestDistance) {
              bestDistance = distance;
            }
          });

          // 比较最佳距离与阈值
          if (bestDistance < MATCH_THRESHOLD) {
            const similarity = ((1 - bestDistance) * 100).toFixed(1);
            videoOverlay.className = 'video-overlay match';
            videoOverlay.textContent = `✅ 匹配成功！相似度: ${similarity}%`;
          } else {
            videoOverlay.className = 'video-overlay no-match';
            videoOverlay.textContent = `❌ 人脸不匹配 (距离: ${bestDistance.toFixed(2)})`;
          }
        } else {
          videoOverlay.className = 'video-overlay checking';
          videoOverlay.textContent = `未检测到人脸，请调整位置`;
        }
      } catch (error) {
        console.error('人脸检测或比对错误:', error);
      }

      // 循环调用
      requestAnimationFrame(detectFaces);
    }

    // 按钮点击事件监听
    startBtn.addEventListener('click', () => {
      if (!isDetecting) {
        startVideo();
      } else {
        stopVideo();
      }
    });

    // 页面加载完成后，立即开始加载模型
    window.addEventListener('load', loadModelsAndReference);
  </script>
</body>

</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excelæ•°æ®å¤„ç†å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .title {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .upload-section {
            background: #f8f9ff;
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            background: #f0f2ff;
            border-color: #5a6fd8;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .process-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .process-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e6ff;
        }
        
        .process-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .icon {
            font-size: 1.5rem;
        }
        
        .process-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .process-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        
        .process-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .result-area {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e0e6ff;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .data-table th,
        .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .data-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f8f9ff;
        }
        
        .download-btn {
            background: linear-gradient(45deg, #FF6B6B, #ee5a52);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 15px;
        }
        
        .download-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .sample-data {
            background: #f0f8ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .sample-data h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .process-section {
                grid-template-columns: 1fr;
            }
            
            .title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">ğŸ“Š Excelæ•°æ®å¤„ç†å·¥å…·</h1>
        
        <div class="upload-section">
            <h3>ğŸ“ ä¸Šä¼ Excelæ–‡ä»¶</h3>
            <p style="color: #666; margin: 10px 0;">æ”¯æŒ.xlsxå’Œ.xlsæ ¼å¼</p>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                é€‰æ‹©æ–‡ä»¶
            </button>
            <div id="fileName" style="margin-top: 10px; color: #666;"></div>
            
            <!-- å·¥ä½œè¡¨é€‰æ‹© -->
            <div id="sheetSelector" style="margin-top: 20px; display: none;">
                <h4 style="color: #333; margin-bottom: 10px;">ğŸ“‹ é€‰æ‹©è¦å¤„ç†çš„å·¥ä½œè¡¨ï¼š</h4>
                <select id="sheetSelect" style="padding: 10px; border: 2px solid #667eea; border-radius: 8px; font-size: 1rem; width: 100%; max-width: 300px;">
                </select>
                <button class="upload-btn" onclick="loadSelectedSheet()" style="margin-top: 10px; padding: 10px 20px;">
                    åŠ è½½é€‰ä¸­çš„å·¥ä½œè¡¨
                </button>
            </div>
            
            <!-- æ•°æ®é¢„è§ˆ -->
            <div id="dataPreview" style="margin-top: 20px; display: none;">
                <h4 style="color: #333;">ğŸ“Š æ•°æ®é¢„è§ˆï¼ˆå‰5è¡Œï¼‰ï¼š</h4>
                <div id="previewTable" style="margin-top: 10px; overflow-x: auto;"></div>
            </div>
        </div>
        
        <div class="process-section">
            <div class="process-card">
                <h3><span class="icon">ğŸ”„</span>æ•°æ®å»é‡å¤„ç†</h3>
                <p style="color: #666; margin-bottom: 15px;">åŸºäºé€‰æ‹©çš„åˆ—ç§»é™¤é‡å¤çš„è¡Œæ•°æ®</p>
                
                <!-- å»é‡åˆ—é€‰æ‹©é…ç½® -->
                <div id="dedupeColumnSelector" style="margin-bottom: 15px; display: none;">
                    <div style="background: #f8f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: #333; margin-bottom: 10px;">ğŸ¯ é€‰æ‹©å»é‡ä¾æ®åˆ—ï¼š</h4>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: 600; color: #555; margin-bottom: 5px;">
                                ğŸ” å»é‡æ¨¡å¼ï¼š
                            </label>
                            <select id="dedupeMode" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;" onchange="toggleDedupeColumns()">
                                <option value="all">å®Œæ•´è¡Œå»é‡ï¼ˆæ‰€æœ‰åˆ—éƒ½ç›¸åŒæ‰ç®—é‡å¤ï¼‰</option>
                                <option value="selected">æŒ‡å®šåˆ—å»é‡ï¼ˆé€‰æ‹©çš„åˆ—ç›¸åŒå°±ç®—é‡å¤ï¼‰</option>
                            </select>
                        </div>
                        
                        <div id="dedupeColumnsSelection" style="margin-bottom: 10px; display: none;">
                            <label style="display: block; font-weight: 600; color: #555; margin-bottom: 5px;">
                                ğŸ“‹ é€‰æ‹©å»é‡ä¾æ®åˆ—ï¼ˆå¤šé€‰ï¼‰ï¼š
                            </label>
                            <div id="dedupeColumnsCheckboxes" style="max-height: 120px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: white;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: 600; color: #555; margin-bottom: 5px;">
                                âš™ï¸ ä¿ç•™ç­–ç•¥ï¼š
                            </label>
                            <select id="keepStrategy" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                                <option value="first">ä¿ç•™ç¬¬ä¸€æ¬¡å‡ºç°çš„æ•°æ®</option>
                                <option value="last">ä¿ç•™æœ€åä¸€æ¬¡å‡ºç°çš„æ•°æ®</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <button class="process-btn" id="dedupeBtn" onclick="deduplicateData()" disabled>
                    æ‰§è¡Œå»é‡
                </button>
                <div class="sample-data">
                    <h4>ç¤ºä¾‹æ•°æ®æ ¼å¼ï¼š</h4>
                    <pre style="color: #555; font-size: 0.9rem;">æå››  æ•°å­¦: 60
æå››  è¯­æ–‡: 60
æå››  æ•°å­¦: 60  â† é‡å¤è¡Œ</pre>
                    <p style="color: #888; font-size: 0.8rem; margin-top: 5px;">*å¯é€‰æ‹©åŸºäºæ‰€æœ‰åˆ—æˆ–æŒ‡å®šåˆ—è¿›è¡Œå»é‡</p>
                </div>
                <div class="result-area" id="dedupeResult"></div>
            </div>
            
            <div class="process-card">
                <h3><span class="icon">ğŸ“‹</span>æ•°æ®åˆå¹¶å¤„ç†</h3>
                <p style="color: #666; margin-bottom: 15px;">å°†åŒå­¦ç”Ÿçš„ç§‘ç›®æˆç»©åˆå¹¶åˆ°ä¸€è¡Œ</p>
                
                <!-- åˆ—é€‰æ‹©é…ç½® -->
                <div id="columnSelector" style="margin-bottom: 15px; display: none;">
                    <div style="background: #f8f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: #333; margin-bottom: 10px;">ğŸ¯ é€‰æ‹©åˆå¹¶åˆ—ï¼š</h4>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: 600; color: #555; margin-bottom: 5px;">
                                ğŸ“ åˆ†ç»„ä¾æ®åˆ—ï¼ˆç›¸åŒå€¼ä¼šè¢«åˆå¹¶ï¼‰ï¼š
                            </label>
                            <select id="groupByColumn" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: 600; color: #555; margin-bottom: 5px;">
                                ğŸ”— è¦åˆå¹¶çš„åˆ—ï¼ˆå¤šé€‰ï¼‰ï¼š
                            </label>
                            <div id="mergeColumnsCheckboxes" style="max-height: 120px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: white;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: 600; color: #555; margin-bottom: 5px;">
                                âš™ï¸ åˆå¹¶åˆ†éš”ç¬¦ï¼š
                            </label>
                            <select id="separator" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                                <option value=", ">é€—å· (,)</option>
                                <option value=" | ">ç«–çº¿ (|)</option>
                                <option value="; ">åˆ†å· (;)</option>
                                <option value=" / ">æ–œçº¿ (/)</option>
                                <option value=" - ">æ¨ªçº¿ (-)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <button class="process-btn" id="mergeBtn" onclick="mergeData()" disabled>
                    æ‰§è¡Œåˆå¹¶
                </button>
                <div class="sample-data">
                    <h4>åˆå¹¶åæ ¼å¼ï¼š</h4>
                    <pre style="color: #555; font-size: 0.9rem;">æå››  æ•°å­¦: 60, è¯­æ–‡: 60, è‹±æ–‡: 60</pre>
                    <p style="color: #888; font-size: 0.8rem; margin-top: 5px;">*å¯è‡ªå®šä¹‰åˆ†ç»„åˆ—å’Œåˆå¹¶åˆ—</p>
                </div>
                <div class="result-area" id="mergeResult"></div>
            </div>
        </div>
    </div>

    <script>
        let workbook = null;
        let originalData = [];
        let deduplicatedData = [];
        let mergedData = [];

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = `å·²é€‰æ‹©: ${file.name}`;
                readExcelFile(file);
            }
        });

        function readExcelFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array' });
                    
                    // æ˜¾ç¤ºå·¥ä½œè¡¨é€‰æ‹©å™¨
                    displaySheetSelector(workbook.SheetNames);
                    
                } catch (error) {
                    alert('æ–‡ä»¶è¯»å–é”™è¯¯: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function displaySheetSelector(sheetNames) {
            const sheetSelector = document.getElementById('sheetSelector');
            const sheetSelect = document.getElementById('sheetSelect');
            
            // æ¸…ç©ºé€‰é¡¹
            sheetSelect.innerHTML = '';
            
            // æ·»åŠ å·¥ä½œè¡¨é€‰é¡¹
            sheetNames.forEach((sheetName, index) => {
                const option = document.createElement('option');
                option.value = sheetName;
                option.textContent = `${sheetName} (å·¥ä½œè¡¨${index + 1})`;
                sheetSelect.appendChild(option);
            });
            
            sheetSelector.style.display = 'block';
            
            // é»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
            if (sheetNames.length > 0) {
                loadSheet(sheetNames[0]);
            }
        }

        function loadSelectedSheet() {
            const selectedSheet = document.getElementById('sheetSelect').value;
            loadSheet(selectedSheet);
        }

        function loadSheet(sheetName) {
            try {
                const worksheet = workbook.Sheets[sheetName];
                
                // è½¬æ¢ä¸ºJSONæ•°ç»„
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                    header: 1,
                    defval: "" 
                });
                
                originalData = jsonData.filter(row => row.some(cell => cell !== ""));
                
                // æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
                displayDataPreview(originalData, sheetName);
                
                // å¯ç”¨å¤„ç†æŒ‰é’®
                document.getElementById('dedupeBtn').disabled = false;
                document.getElementById('mergeBtn').disabled = false;
                
                // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
                document.getElementById('dedupeResult').innerHTML = '';
                document.getElementById('mergeResult').innerHTML = '';
                deduplicatedData = [];
                mergedData = [];
                
                console.log(`${sheetName} æ•°æ®:`, originalData);
                
            } catch (error) {
                alert('å·¥ä½œè¡¨è¯»å–é”™è¯¯: ' + error.message);
            }
        }

        function displayDataPreview(data, sheetName) {
            const previewDiv = document.getElementById('dataPreview');
            const previewTable = document.getElementById('previewTable');
            
            if (data.length === 0) {
                previewDiv.style.display = 'none';
                return;
            }
            
            // åªæ˜¾ç¤ºå‰5è¡Œæ•°æ®
            const previewData = data.slice(0, 5);
            
            let html = `<p style="color: #666; margin-bottom: 10px;">å·¥ä½œè¡¨: <strong>${sheetName}</strong> | æ€»è¡Œæ•°: <strong>${data.length}</strong></p>`;
            html += '<table class="data-table" style="font-size: 0.9rem;">';
            
            // è¡¨å¤´
            if (previewData.length > 0) {
                html += '<tr>';
                for (let i = 0; i < previewData[0].length; i++) {
                    html += `<th>åˆ—${String.fromCharCode(65 + i)}</th>`;
                }
                html += '</tr>';
            }
            
            // æ•°æ®è¡Œ
            previewData.forEach((row, index) => {
                html += '<tr>';
                row.forEach(cell => {
                    html += `<td>${cell || ''}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</table>';
            
            if (data.length > 5) {
                html += '<p style="color: #888; font-size: 0.9rem; margin-top: 10px;">... è¿˜æœ‰æ›´å¤šæ•°æ®</p>';
            }
            
            previewTable.innerHTML = html;
            previewDiv.style.display = 'block';
            
            // ç”Ÿæˆåˆ—é€‰æ‹©å™¨
            generateColumnSelectors(data);
        }

        function generateColumnSelectors(data) {
            if (data.length === 0) return;
            
            const columnSelector = document.getElementById('columnSelector');
            const dedupeColumnSelector = document.getElementById('dedupeColumnSelector');
            const groupByColumn = document.getElementById('groupByColumn');
            const mergeColumnsCheckboxes = document.getElementById('mergeColumnsCheckboxes');
            const dedupeColumnsCheckboxes = document.getElementById('dedupeColumnsCheckboxes');
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            groupByColumn.innerHTML = '';
            mergeColumnsCheckboxes.innerHTML = '';
            dedupeColumnsCheckboxes.innerHTML = '';
            
            // è·å–åˆ—æ•°
            const maxColumns = Math.max(...data.map(row => row.length));
            
            // ç”Ÿæˆåˆ†ç»„åˆ—é€‰é¡¹ï¼ˆåˆå¹¶åŠŸèƒ½ï¼‰
            for (let i = 0; i < maxColumns; i++) {
                const columnLetter = String.fromCharCode(65 + i);
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `åˆ—${columnLetter} (ç¬¬${i + 1}åˆ—)`;
                groupByColumn.appendChild(option);
            }
            
            // ç”Ÿæˆè¦åˆå¹¶çš„åˆ—å¤é€‰æ¡†ï¼ˆåˆå¹¶åŠŸèƒ½ï¼‰
            for (let i = 0; i < maxColumns; i++) {
                const columnLetter = String.fromCharCode(65 + i);
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.marginBottom = '5px';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `mergeCol${i}`;
                checkbox.value = i;
                checkbox.style.marginRight = '8px';
                
                const label = document.createElement('label');
                label.htmlFor = `mergeCol${i}`;
                label.textContent = `åˆ—${columnLetter} (ç¬¬${i + 1}åˆ—)`;
                label.style.cursor = 'pointer';
                
                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                mergeColumnsCheckboxes.appendChild(checkboxDiv);
            }
            
            // ç”Ÿæˆå»é‡åˆ—å¤é€‰æ¡†ï¼ˆå»é‡åŠŸèƒ½ï¼‰
            for (let i = 0; i < maxColumns; i++) {
                const columnLetter = String.fromCharCode(65 + i);
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.marginBottom = '5px';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `dedupeCol${i}`;
                checkbox.value = i;
                checkbox.style.marginRight = '8px';
                
                const label = document.createElement('label');
                label.htmlFor = `dedupeCol${i}`;
                label.textContent = `åˆ—${columnLetter} (ç¬¬${i + 1}åˆ—)`;
                label.style.cursor = 'pointer';
                
                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                dedupeColumnsCheckboxes.appendChild(checkboxDiv);
            }
            
            // é»˜è®¤é€‰æ‹©ï¼šç¬¬ä¸€åˆ—ä½œä¸ºåˆ†ç»„ï¼Œå…¶ä»–åˆ—ä½œä¸ºåˆå¹¶ï¼ˆåˆå¹¶åŠŸèƒ½ï¼‰
            if (maxColumns > 1) {
                groupByColumn.value = '0';
                for (let i = 1; i < maxColumns; i++) {
                    document.getElementById(`mergeCol${i}`).checked = true;
                }
            }
            
            // é»˜è®¤é€‰æ‹©ï¼šæ‰€æœ‰åˆ—éƒ½é€‰ä¸­ï¼ˆå»é‡åŠŸèƒ½ï¼‰
            for (let i = 0; i < maxColumns; i++) {
                document.getElementById(`dedupeCol${i}`).checked = true;
            }
            
            columnSelector.style.display = 'block';
            dedupeColumnSelector.style.display = 'block';
        }

        function toggleDedupeColumns() {
            const dedupeMode = document.getElementById('dedupeMode').value;
            const dedupeColumnsSelection = document.getElementById('dedupeColumnsSelection');
            
            if (dedupeMode === 'selected') {
                dedupeColumnsSelection.style.display = 'block';
            } else {
                dedupeColumnsSelection.style.display = 'none';
            }
        }

        function deduplicateData() {
            if (originalData.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ æ–‡ä»¶å¹¶é€‰æ‹©å·¥ä½œè¡¨');
                return;
            }

            const dedupeMode = document.getElementById('dedupeMode').value;
            const keepStrategy = document.getElementById('keepStrategy').value;
            
            let dedupeColumnIndices = [];
            
            if (dedupeMode === 'selected') {
                // è·å–é€‰ä¸­çš„å»é‡åˆ—
                const maxColumns = Math.max(...originalData.map(row => row.length));
                for (let i = 0; i < maxColumns; i++) {
                    const checkbox = document.getElementById(`dedupeCol${i}`);
                    if (checkbox && checkbox.checked) {
                        dedupeColumnIndices.push(i);
                    }
                }
                
                if (dedupeColumnIndices.length === 0) {
                    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€åˆ—ä½œä¸ºå»é‡ä¾æ®');
                    return;
                }
            }

            // å»é‡é€»è¾‘
            const seen = new Map();
            const duplicateIndexes = new Set();
            
            originalData.forEach((row, index) => {
                let keyStr;
                
                if (dedupeMode === 'all') {
                    // å®Œæ•´è¡Œå»é‡
                    keyStr = JSON.stringify(row);
                } else {
                    // æŒ‡å®šåˆ—å»é‡
                    const keyValues = dedupeColumnIndices.map(colIndex => 
                        row[colIndex] !== undefined ? row[colIndex] : ''
                    );
                    keyStr = JSON.stringify(keyValues);
                }
                
                if (seen.has(keyStr)) {
                    // å‘ç°é‡å¤
                    const firstIndex = seen.get(keyStr);
                    if (keepStrategy === 'first') {
                        duplicateIndexes.add(index); // æ ‡è®°å½“å‰è¡Œä¸ºé‡å¤ï¼ˆä¿ç•™ç¬¬ä¸€æ¬¡å‡ºç°çš„ï¼‰
                    } else {
                        duplicateIndexes.add(firstIndex); // æ ‡è®°ç¬¬ä¸€æ¬¡å‡ºç°çš„ä¸ºé‡å¤ï¼ˆä¿ç•™æœ€åä¸€æ¬¡å‡ºç°çš„ï¼‰
                        seen.set(keyStr, index); // æ›´æ–°ä¸ºå½“å‰ç´¢å¼•
                    }
                } else {
                    seen.set(keyStr, index);
                }
            });

            // è¿‡æ»¤æ‰é‡å¤çš„è¡Œ
            deduplicatedData = originalData.filter((row, index) => !duplicateIndexes.has(index));

            // ç”Ÿæˆå»é‡æŠ¥å‘Š
            const removedCount = originalData.length - deduplicatedData.length;
            let reportTitle = `å»é‡åæ•°æ® (åŸå§‹${originalData.length}è¡Œï¼Œå»é™¤${removedCount}è¡Œé‡å¤æ•°æ®)`;
            
            if (dedupeMode === 'selected') {
                const selectedColumns = dedupeColumnIndices.map(i => 
                    `åˆ—${String.fromCharCode(65 + i)}`
                ).join(', ');
                reportTitle += ` | åŸºäºåˆ—: ${selectedColumns}`;
            } else {
                reportTitle += ' | åŸºäº: å®Œæ•´è¡Œ';
            }
            
            reportTitle += ` | ç­–ç•¥: ${keepStrategy === 'first' ? 'ä¿ç•™é¦–æ¬¡å‡ºç°' : 'ä¿ç•™æœ€åå‡ºç°'}`;

            displayResult('dedupeResult', deduplicatedData, reportTitle);
            console.log('å»é‡åæ•°æ®:', deduplicatedData);
        }

        function mergeData() {
            if (originalData.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ æ–‡ä»¶å¹¶é€‰æ‹©å·¥ä½œè¡¨');
                return;
            }

            // è·å–ç”¨æˆ·é€‰æ‹©çš„é…ç½®
            const groupByColumnIndex = parseInt(document.getElementById('groupByColumn').value);
            const separator = document.getElementById('separator').value;
            
            // è·å–é€‰ä¸­è¦åˆå¹¶çš„åˆ—
            const mergeColumnIndices = [];
            const maxColumns = Math.max(...originalData.map(row => row.length));
            for (let i = 0; i < maxColumns; i++) {
                const checkbox = document.getElementById(`mergeCol${i}`);
                if (checkbox && checkbox.checked) {
                    mergeColumnIndices.push(i);
                }
            }
            
            if (mergeColumnIndices.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€åˆ—è¿›è¡Œåˆå¹¶');
                return;
            }

            // æŒ‰åˆ†ç»„åˆ—è¿›è¡Œåˆ†ç»„åˆå¹¶
            const grouped = {};
            
            originalData.forEach(row => {
                if (row.length > groupByColumnIndex) {
                    const groupKey = row[groupByColumnIndex] || '';
                    
                    if (groupKey) {
                        if (!grouped[groupKey]) {
                            grouped[groupKey] = {
                                groupValue: groupKey,
                                mergeValues: {}
                            };
                            // åˆå§‹åŒ–æ¯ä¸ªè¦åˆå¹¶çš„åˆ—
                            mergeColumnIndices.forEach(colIndex => {
                                grouped[groupKey].mergeValues[colIndex] = [];
                            });
                        }
                        
                        // æ”¶é›†è¦åˆå¹¶çš„åˆ—çš„å€¼
                        mergeColumnIndices.forEach(colIndex => {
                            if (row.length > colIndex && row[colIndex]) {
                                const value = row[colIndex].toString().trim();
                                if (value && !grouped[groupKey].mergeValues[colIndex].includes(value)) {
                                    grouped[groupKey].mergeValues[colIndex].push(value);
                                }
                            }
                        });
                    }
                }
            });

            // è½¬æ¢ä¸ºæœ€ç»ˆæ ¼å¼
            mergedData = Object.keys(grouped).map(groupKey => {
                const group = grouped[groupKey];
                const result = [group.groupValue];
                
                // æŒ‰åˆ—é¡ºåºæ·»åŠ åˆå¹¶åçš„å€¼
                mergeColumnIndices.forEach(colIndex => {
                    const values = group.mergeValues[colIndex];
                    const mergedValue = values.join(separator);
                    result.push(mergedValue);
                });
                
                return result;
            });

            // ç”Ÿæˆè¡¨å¤´
            const headers = [`åˆ†ç»„åˆ— (åˆ—${String.fromCharCode(65 + groupByColumnIndex)})`];
            mergeColumnIndices.forEach(colIndex => {
                headers.push(`åˆå¹¶åˆ— (åˆ—${String.fromCharCode(65 + colIndex)})`);
            });

            displayResultWithHeaders('mergeResult', mergedData, 'åˆå¹¶åæ•°æ®', headers);
            console.log('åˆå¹¶åæ•°æ®:', mergedData);
        }

        function displayResult(containerId, data, title) {
            displayResultWithHeaders(containerId, data, title, null);
        }

        function displayResultWithHeaders(containerId, data, title, headers) {
            const container = document.getElementById(containerId);
            
            if (data.length === 0) {
                container.innerHTML = '<p>æ²¡æœ‰æ•°æ®å¯æ˜¾ç¤º</p>';
                return;
            }

            let html = `<h4>${title} (å…±${data.length}è¡Œ)</h4>`;
            html += '<table class="data-table">';
            
            // è¡¨å¤´
            if (headers && headers.length > 0) {
                html += '<tr>';
                headers.forEach(header => {
                    html += `<th>${header}</th>`;
                });
                html += '</tr>';
            } else if (data.length > 0) {
                html += '<tr>';
                for (let i = 0; i < data[0].length; i++) {
                    html += `<th>åˆ—${i + 1}</th>`;
                }
                html += '</tr>';
            }

            // æ•°æ®è¡Œ
            data.forEach(row => {
                html += '<tr>';
                row.forEach(cell => {
                    html += `<td>${cell || ''}</td>`;
                });
                html += '</tr>';
            });

            html += '</table>';
            
            // æ·»åŠ ä¸‹è½½æŒ‰é’®
            html += `<button class="download-btn" onclick="downloadData('${containerId}')">ä¸‹è½½Excelæ–‡ä»¶</button>`;
            
            container.innerHTML = html;
        }

        function downloadData(type) {
            let dataToDownload = [];
            let filename = '';

            if (type === 'dedupeResult') {
                dataToDownload = deduplicatedData;
                filename = 'å»é‡åæ•°æ®.xlsx';
            } else if (type === 'mergeResult') {
                dataToDownload = mergedData;
                filename = 'åˆå¹¶åæ•°æ®.xlsx';
            }

            if (dataToDownload.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯ä¸‹è½½');
                return;
            }

            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dataToDownload);
            
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            
            // ä¸‹è½½æ–‡ä»¶
            XLSX.writeFile(wb, filename);
        }
    </script>
</body>
</html>
